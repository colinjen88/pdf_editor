<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <style>
        .search-highlight {
            background: linear-gradient(90deg, #fef08a 60%, #f59e0b 100%);
            color: #222;
            border-radius: 4px;
            padding: 0 2px;
            box-shadow: 0 0 2px #f59e0b;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vibe PDF Editor</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- PDF Libs -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        vibe: {
                            bg: '#0F1117',
                            surface: '#1E212B',
                            accent: '#6366F1',
                            text: '#E2E8F0',
                            border: '#2D3748'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0F1117;
            color: #E2E8F0;
            overflow: hidden;
        }

        /* 自定義捲軸 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1E212B;
        }

        ::-webkit-scrollbar-thumb {
            background: #4A5568;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        .canvas-container {
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .tool-btn {
            @apply p-3 rounded-2xl text-gray-300 hover:text-white hover:bg-vibe-surface transition-all duration-200 flex flex-col items-center gap-1.5 text-sm;
        }

        .tool-btn.active {
            @apply bg-indigo-600/20 text-indigo-400 border border-indigo-500/30;
        }

        /* 拖曳中的文字 */
        .draggable-text {
            position: absolute;
            cursor: move;
            border: 1px dashed transparent;
            padding: 2px 6px;
            background: rgba(0, 0, 0, 0.1);
            color: black;
            /* 預設為黑色，因為 PDF 背景通常是白色 */
            font-family: Helvetica, sans-serif;
            font-size: 16px;
            min-width: 50px;
            outline: none;
            border-radius: 4px;
        }

        .draggable-text:focus {
            border-color: #6366F1;
            background: rgba(99, 102, 241, 0.1);
        }

        /* 繪圖層 */
        #drawing-layer {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            pointer-events: none;
            /* 預設不攔截事件，除非在繪圖模式 */
        }

        #drawing-layer.drawing-mode {
            pointer-events: auto;
            cursor: crosshair;
        }

        .page-indicator {
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        .page-item {
            border: 1px solid transparent;
        }

        .page-item.active {
            border-color: #6366F1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.35);
        }

        .page-item.drag-over {
            border-color: #818CF8;
            background: rgba(99, 102, 241, 0.08);
        }

        /* ===== Mobile Responsive (≤ 768px) ===== */
        @media (max-width: 768px) {

            /* --- Header --- */
            header {
                padding: env(safe-area-inset-top, 0) 8px 0 8px !important;
                height: calc(48px + env(safe-area-inset-top, 0)) !important;
                gap: 4px !important;
            }

            header h1 {
                display: none !important;
            }

            /* --- Hide desktop-only elements --- */
            #search-bar,
            .fixed.top-20,
            .header-center-controls,
            .header-desktop-tools,
            .header-desktop-settings,
            .header-desktop-filter {
                display: none !important;
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            /* Logo smaller on mobile */
            header .w-9 {
                width: 32px !important;
                height: 32px !important;
                font-size: 14px !important;
            }

            /* Export button compact */
            header button[onclick="downloadPdf()"] {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            /* --- Left Sidebar: hidden --- */
            .desktop-sidebar-left {
                display: none !important;
            }

            /* --- Right Sidebar: slide-in drawer --- */
            .mobile-sidebar-right {
                position: fixed !important;
                top: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 78vw !important;
                max-width: 300px !important;
                padding-top: calc(48px + env(safe-area-inset-top, 0)) !important;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
                z-index: 100 !important;
                box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5);
                border-left: none !important;
                overflow-y: auto !important;
            }

            .mobile-sidebar-right.open {
                transform: translateX(0);
            }

            /* Sidebar header area - compact */
            .mobile-sidebar-right>div:first-child {
                padding: 10px 12px !important;
            }

            .mobile-sidebar-right>div:first-child>div:first-child {
                margin-bottom: 8px !important;
            }

            .mobile-sidebar-right>div:first-child h2 {
                font-size: 13px !important;
            }

            /* Sidebar buttons grid - compact layout */
            .mobile-sidebar-right .grid {
                gap: 6px !important;
            }

            .mobile-sidebar-right .grid button {
                padding: 6px 8px !important;
                font-size: 12px !important;
                gap: 4px !important;
                border-radius: 8px !important;
            }

            .mobile-sidebar-right .grid button i {
                font-size: 14px !important;
            }

            /* Full-width buttons in sidebar */
            .mobile-sidebar-right .grid .col-span-2 {
                padding: 8px 10px !important;
            }

            /* Drag hint */
            .mobile-sidebar-right .border-t {
                margin-top: 8px !important;
                padding-top: 6px !important;
            }

            /* Page list area */
            .mobile-sidebar-right #page-list {
                padding: 8px !important;
                gap: 6px !important;
            }

            /* --- Sidebar Overlay --- */
            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(3px);
                -webkit-backdrop-filter: blur(3px);
                z-index: 99;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* --- Main Canvas --- */
            #main-scroll {
                padding: 8px 4px calc(68px + env(safe-area-inset-bottom, 0)) 4px !important;
            }

            #empty-state {
                border-width: 2px !important;
                border-radius: 12px !important;
                margin: 4px !important;
            }

            #empty-state i {
                font-size: 2.5rem !important;
                margin-bottom: 8px !important;
            }

            #empty-state p {
                font-size: 13px !important;
                line-height: 1.4 !important;
            }

            /* --- Footer: hidden on mobile --- */
            footer {
                display: none !important;
            }

            /* --- Mobile Bottom Toolbar --- */
            .mobile-toolbar {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: calc(56px + env(safe-area-inset-bottom, 0));
                padding: 0 2px env(safe-area-inset-bottom, 0) 2px;
                background: rgba(20, 22, 30, 0.97);
                border-top: 1px solid rgba(255, 255, 255, 0.06);
                z-index: 90;
                align-items: center;
                justify-content: space-evenly;
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
            }

            .mobile-toolbar button {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 1px;
                min-width: 40px;
                min-height: 44px;
                padding: 4px 3px;
                border-radius: 8px;
                color: rgba(160, 174, 192, 0.7);
                font-size: 9px;
                font-weight: 500;
                transition: all 0.15s ease;
                border: none;
                background: none;
                -webkit-tap-highlight-color: transparent;
                position: relative;
            }

            .mobile-toolbar button:active {
                transform: scale(0.88);
            }

            .mobile-toolbar button.active {
                color: #818CF8;
                background: rgba(99, 102, 241, 0.12);
            }

            .mobile-toolbar button.active::after {
                content: '';
                position: absolute;
                bottom: 1px;
                left: 50%;
                transform: translateX(-50%);
                width: 14px;
                height: 2px;
                border-radius: 1px;
                background: #818CF8;
            }

            .mobile-toolbar button i {
                font-size: 18px;
                line-height: 1;
            }

            .mobile-toolbar .toolbar-divider {
                width: 1px;
                height: 24px;
                background: rgba(255, 255, 255, 0.06);
                flex-shrink: 0;
            }

            /* Page nav group */
            .mobile-page-nav {
                display: flex !important;
                align-items: center;
                gap: 0;
            }

            .mobile-page-nav button {
                min-width: 32px;
                padding: 4px 2px;
                font-size: 0;
            }

            .mobile-page-nav button i {
                font-size: 16px;
            }

            .mobile-page-nav>span {
                font-size: 10px;
                color: rgba(160, 174, 192, 0.7);
                white-space: nowrap;
                font-variant-numeric: tabular-nums;
                line-height: 1;
            }

            /* --- Modals: bottom sheet --- */
            .fixed.inset-0>div,
            .modal-content {
                width: 100vw !important;
                max-width: 100vw !important;
                min-width: auto !important;
                max-height: 75vh;
                overflow-y: auto;
                border-radius: 16px 16px 0 0 !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                top: auto !important;
                padding: 16px 14px calc(14px + env(safe-area-inset-bottom, 0)) 14px !important;
                box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.4);
            }

            .fixed.inset-0 {
                align-items: flex-end !important;
            }

            /* --- Draw Toolbar --- */
            #draw-toolbar {
                top: calc(52px + env(safe-area-inset-top, 0)) !important;
                left: 6px !important;
                right: 6px !important;
                padding: 6px 8px !important;
                font-size: 11px;
                border-radius: 10px !important;
                gap: 6px !important;
            }

            #draw-toolbar label {
                font-size: 11px;
            }

            #draw-toolbar input[type="color"] {
                width: 28px !important;
                height: 28px !important;
            }

            #draw-toolbar input[type="number"] {
                width: 48px !important;
                padding: 2px 4px !important;
                font-size: 11px;
            }

            #draw-toolbar button {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }

            /* PDF canvas */
            #pdf-render {
                border-radius: 8px !important;
                border-width: 1px !important;
            }
        }

        /* ===== Tablet (769px – 1024px) ===== */
        @media (min-width: 769px) and (max-width: 1024px) {
            header {
                padding-left: 16px !important;
                padding-right: 16px !important;
            }

            .header-desktop-settings {
                display: none !important;
            }

            .desktop-sidebar-left {
                width: 64px !important;
                padding-top: 16px !important;
                padding-bottom: 16px !important;
                gap: 6px !important;
            }

            .desktop-sidebar-left .tool-btn span {
                font-size: 9px !important;
            }

            .desktop-sidebar-left .tool-btn i {
                font-size: 22px !important;
            }

            .mobile-sidebar-right {
                width: 260px !important;
            }
        }

        /* ===== Desktop (> 768px): hide mobile-only elements ===== */
        @media (min-width: 769px) {
            .mobile-toolbar {
                display: none !important;
            }

            .mobile-menu-btn {
                display: none !important;
            }

            .sidebar-overlay {
                display: none !important;
            }

            .mobile-page-nav {
                display: none !important;
            }
        }
    </style>
</head>

<body class="flex flex-col h-screen font-sans bg-vibe-bg text-vibe-text">
    <!-- Toast/Loading/主題切換區 -->
    <div id="ui-overlays" class="fixed inset-0 pointer-events-none z-[100]"></div>
    <!-- 搜尋工具欄 -->
    <div id="search-bar"
        class="hidden md:flex fixed top-20 left-1/2 -translate-x-1/2 z-[102] items-center gap-2 bg-vibe-surface border border-vibe-border rounded-xl shadow-lg px-4 py-2"
        style="min-width:280px; max-width:90vw">
        <input id="search-input" type="text" placeholder="搜尋PDF文字..."
            class="flex-1 min-w-0 px-3 py-2 rounded border border-vibe-border bg-white text-black dark:bg-vibe-surface dark:text-vibe-text"
            style="min-width:0">
        <button id="search-btn" class="px-3 py-2 rounded bg-indigo-500 text-white font-medium whitespace-nowrap"><i
                class="ph ph-magnifying-glass"></i> 搜尋</button>
        <span id="search-count" class="text-sm text-gray-400"></span>
    </div>

    <!-- Header -->
    <header
        class="h-14 md:h-16 border-b border-vibe-border bg-vibe-bg/95 backdrop-blur flex items-center justify-between px-3 md:px-8 shadow z-50 relative">
        <!-- Logo -->
        <div class="flex items-center gap-2 md:gap-3">
            <div
                class="w-8 h-8 md:w-9 md:h-9 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-base md:text-lg shadow-lg shadow-indigo-500/20">
                V</div>
            <h1 class="hidden md:block font-semibold text-xl tracking-tight text-gray-100" id="main-title">Vibe PDF</h1>
        </div>

        <!-- Center Controls (desktop only) -->
        <div
            class="header-center-controls absolute left-1/2 -translate-x-1/2 flex items-center gap-2 bg-vibe-surface/80 p-1.5 rounded-xl border border-vibe-border backdrop-blur-sm shadow-sm lg:flex hidden">
            <button onclick="undoAction()"
                class="p-1.5 rounded-lg hover:bg-vibe-border hover:text-indigo-400 transition-colors text-vibe-text"
                title="復原 (Undo)">
                <i class="ph ph-arrow-counter-clockwise text-lg"></i>
            </button>
            <div class="w-px h-4 bg-vibe-border/50"></div>
            <button onclick="redoAction()"
                class="p-1.5 rounded-lg hover:bg-vibe-border hover:text-indigo-400 transition-colors text-vibe-text"
                title="重做 (Redo)">
                <i class="ph ph-arrow-clockwise text-lg"></i>
            </button>
        </div>

        <!-- Right Toolbar -->
        <div class="flex items-center gap-2">
            <!-- Settings (desktop only) -->
            <div class="header-desktop-settings flex items-center gap-3 mr-2 hidden lg:flex">
                <select id="theme-select"
                    class="bg-transparent text-xs text-gray-500 hover:text-vibe-text transition-colors outline-none cursor-pointer"
                    onchange="setThemeColor(this.value)">
                    <option value="indigo">藍紫 Theme</option>
                    <option value="emerald">翠綠 Theme</option>
                    <option value="rose">玫瑰 Theme</option>
                    <option value="amber">琥珀 Theme</option>
                </select>
                <select id="lang-select"
                    class="bg-transparent text-xs text-gray-500 hover:text-vibe-text transition-colors outline-none cursor-pointer"
                    onchange="setLang(this.value)">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                </select>
            </div>

            <!-- Open PDF (always visible) -->
            <label
                class="cursor-pointer p-2 rounded-lg hover:bg-vibe-surface hover:text-indigo-400 text-gray-400 transition-all active:scale-95"
                title="開啟 PDF">
                <i class="ph ph-folder-open text-xl"></i>
                <input type="file" id="file-upload" accept="application/pdf" class="hidden">
            </label>

            <!-- Desktop tools (hidden on mobile) -->
            <div
                class="header-desktop-tools flex items-center gap-1 bg-vibe-surface/50 p-1 rounded-lg border border-vibe-border/30">
                <button onclick="undoAction()"
                    class="lg:hidden p-2 rounded-lg hover:bg-vibe-surface hover:text-indigo-400 text-gray-400 transition-all"
                    title="復原">
                    <i class="ph ph-arrow-counter-clockwise text-xl"></i>
                </button>
                <button onclick="redoAction()"
                    class="lg:hidden p-2 rounded-lg hover:bg-vibe-surface hover:text-indigo-400 text-gray-400 transition-all"
                    title="重做">
                    <i class="ph ph-arrow-clockwise text-xl"></i>
                </button>
                <button onclick="openCompressModal()"
                    class="p-2 rounded-lg hover:bg-vibe-surface hover:text-indigo-400 text-gray-400 transition-all hover:scale-105 active:scale-95"
                    title="壓縮 PDF">
                    <i class="ph ph-arrows-in text-xl"></i>
                </button>
                <button onclick="openBatchModal()"
                    class="p-2 rounded-lg hover:bg-vibe-surface hover:text-indigo-400 text-gray-400 transition-all hover:scale-105 active:scale-95"
                    title="批次處理">
                    <i class="ph ph-list-check text-xl"></i>
                </button>
                <button onclick="openApiModal()"
                    class="p-2 rounded-lg hover:bg-vibe-surface hover:text-indigo-400 text-gray-400 transition-all hover:scale-105 active:scale-95"
                    title="API/協作">
                    <i class="ph ph-share-network text-xl"></i>
                </button>
                <button onclick="openConvertModal()"
                    class="p-2 rounded-lg hover:bg-vibe-surface hover:text-indigo-400 text-gray-400 transition-all hover:scale-105 active:scale-95"
                    title="轉檔">
                    <i class="ph ph-file-arrow-down text-xl"></i>
                </button>
            </div>

            <!-- Safe filter (desktop only) -->
            <div class="header-desktop-filter flex items-center gap-3">
                <label
                    class="flex items-center gap-2 text-xs text-gray-500 hover:text-vibe-text transition-colors cursor-pointer"
                    title="匯出時移除非標準物件">
                    <input type="checkbox" id="remove-nonstandard" class="accent-indigo-600 w-3.5 h-3.5">
                    <span class="hidden xl:inline">安全過濾</span>
                </label>
            </div>

            <!-- Export (always visible) -->
            <button onclick="downloadPdf()"
                class="group bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-3 py-1.5 rounded-lg shadow-lg shadow-indigo-500/20 transition-all active:scale-95 flex items-center gap-1.5 font-medium">
                <i class="ph ph-download-simple text-lg"></i>
                <span class="hidden sm:inline">匯出</span>
            </button>

            <!-- Theme toggle -->
            <button id="theme-toggle"
                class="p-2 rounded-full border border-vibe-border bg-vibe-surface hover:bg-indigo-600/20 text-gray-400 hover:text-yellow-400 transition-colors text-lg shadow-sm"
                title="切換主題">
                <i class="ph ph-moon"></i>
            </button>

            <!-- Mobile sidebar toggle (mobile only) -->
            <button
                class="mobile-menu-btn hidden p-2 rounded-lg hover:bg-vibe-surface text-gray-400 hover:text-indigo-400 transition-colors"
                onclick="toggleMobileSidebar()" title="頁面管理">
                <i class="ph ph-list text-xl"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- 左側工具欄 -->
        <aside
            class="desktop-sidebar-left w-24 bg-vibe-bg border-r border-vibe-border flex flex-col items-center py-8 gap-4 z-40">
            <button class="tool-btn active" id="tool-cursor" onclick="setTool('cursor')" title="選取">
                <i class="ph ph-cursor text-3xl"></i>
                <span class="mt-1">選取</span>
            </button>
            <button class="tool-btn" id="tool-text" onclick="setTool('text')" title="文字">
                <i class="ph ph-text-t text-3xl"></i>
                <span class="mt-1">文字</span>
            </button>
            <button class="tool-btn" id="tool-draw" onclick="setTool('draw')" title="繪圖">
                <i class="ph ph-pencil-simple text-3xl"></i>
                <span class="mt-1">繪圖</span>
            </button>
            <div class="w-10 h-[1px] bg-vibe-border my-3"></div>
            <button class="tool-btn" onclick="rotatePage()" title="旋轉頁面">
                <i class="ph ph-arrows-clockwise text-3xl"></i>
                <span class="mt-1">旋轉</span>
            </button>
            <button class="tool-btn hover:text-red-400" onclick="deletePage()" title="刪除頁面">
                <i class="ph ph-trash text-3xl"></i>
                <span class="mt-1">刪除</span>
            </button>
        </aside>

        <!-- 主要工作區 -->
        <!-- 主要工作區 -->
        <main
            class="flex-1 bg-[#10121a] relative overflow-auto flex justify-center items-center p-2 md:p-8 pb-20 md:pb-8"
            id="main-scroll">
            <!-- 未加載狀態 -->
            <div id="empty-state"
                class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 border-2 md:border-4 border-dashed border-indigo-500/30 rounded-xl md:rounded-2xl bg-vibe-surface/60 pointer-events-none select-none p-4">
                <i class="ph ph-files text-5xl md:text-7xl mb-2 md:mb-4 opacity-60"></i>
                <p class="text-base md:text-xl font-medium text-center">拖放 PDF 到這裡<br>或點擊上方「開啟 PDF」</p>
            </div>
            <!-- PDF 渲染容器 -->
            <div id="pdf-wrapper" class="relative hidden flex flex-col items-center justify-center">
                <canvas id="pdf-render"
                    class="block rounded-2xl shadow-2xl border-2 border-vibe-border bg-white"></canvas>
                <!-- 繪圖畫布 (覆蓋在 PDF 上) -->
                <canvas id="drawing-layer"></canvas>
                <!-- 文字輸入層 -->
                <div id="text-layer" class="absolute inset-0 z-20 pointer-events-none"></div>
            </div>
        </main>

        <!-- 右側頁面目錄 -->
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
        <aside id="right-sidebar"
            class="mobile-sidebar-right w-80 bg-vibe-bg border-l border-vibe-border flex flex-col transition-all duration-300 shadow-xl z-20">
            <div class="p-4 border-b border-vibe-border bg-vibe-surface/90 backdrop-blur-md sticky top-0 z-10">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-gray-200 flex items-center gap-2">
                        <i class="ph ph-list text-indigo-400"></i>
                        頁面管理
                    </h2>
                    <div class="flex items-center gap-2">
                        <span
                            class="text-xs font-mono text-indigo-300 bg-indigo-500/10 border border-indigo-500/30 px-2 py-0.5 rounded-full"
                            id="page-count-badge">0 頁</span>
                        <button onclick="toggleMobileSidebar()"
                            class="md:hidden p-1.5 rounded-lg hover:bg-vibe-border text-gray-400 hover:text-white transition-colors"
                            title="關閉">
                            <i class="ph ph-x text-base"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="insertSignatureField()"
                        class="col-span-2 group flex items-center justify-center gap-2 text-xs md:text-sm px-2 md:px-3 py-2 md:py-2.5 rounded-lg bg-vibe-surface border border-vibe-border hover:border-indigo-500/50 hover:bg-indigo-500/10 text-vibe-text transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]">
                        <i class="ph ph-pen-nib text-indigo-400 group-hover:text-indigo-300 text-lg"></i>
                        <span>插入簽章欄位</span>
                    </button>

                    <button onclick="insertBlankPage()"
                        class="group flex items-center justify-center gap-2 text-xs md:text-sm px-2 md:px-3 py-2 rounded-lg bg-vibe-surface border border-vibe-border hover:bg-indigo-500/10 hover:border-indigo-500/50 text-vibe-text transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]"
                        title="新增空白頁">
                        <i class="ph ph-plus text-indigo-400 group-hover:text-white"></i> 新增頁
                    </button>
                    <button onclick="triggerImageInsert()"
                        class="group flex items-center justify-center gap-2 text-xs md:text-sm px-2 md:px-3 py-2 rounded-lg bg-vibe-surface border border-vibe-border hover:bg-indigo-500/10 hover:border-indigo-500/50 text-vibe-text transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]"
                        title="插入圖片頁面">
                        <i class="ph ph-image text-indigo-400 group-hover:text-white"></i> 插入圖
                    </button>

                    <button onclick="mergeSelectedPages()"
                        class="group flex items-center justify-center gap-2 text-xs md:text-sm px-2 md:px-3 py-2 rounded-lg bg-vibe-surface border border-vibe-border hover:bg-indigo-500/10 hover:border-indigo-500/50 text-vibe-text transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]"
                        title="合併選取頁面">
                        <i class="ph ph-arrows-merge text-indigo-400 group-hover:text-white"></i> 合併
                    </button>
                    <button onclick="splitPage()"
                        class="group flex items-center justify-center gap-2 text-xs md:text-sm px-2 md:px-3 py-2 rounded-lg bg-vibe-surface border border-vibe-border hover:bg-indigo-500/10 hover:border-indigo-500/50 text-vibe-text transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]"
                        title="分割目前頁面">
                        <i class="ph ph-arrows-split text-indigo-400 group-hover:text-white"></i> 分割
                    </button>
                    <button onclick="duplicatePage()"
                        class="col-span-2 group flex items-center justify-center gap-2 text-xs md:text-sm px-2 md:px-3 py-2 rounded-lg bg-vibe-surface border border-vibe-border hover:bg-indigo-500/10 hover:border-indigo-500/50 text-vibe-text transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]">
                        <i class="ph ph-copy text-indigo-400 group-hover:text-white"></i> 複製目前頁面
                    </button>
                </div>
                <div
                    class="mt-4 pt-3 border-t border-vibe-border flex items-center justify-center text-xs text-gray-500 gap-1.5">
                    <i class="ph ph-hand-grabbing text-indigo-400/70"></i>
                    <span>拖曳頁面可重新排序</span>
                </div>
            </div>
            <input type="file" id="image-insert" accept="image/png,image/jpeg" class="hidden" />
            <div id="page-list"
                class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-vibe-border scrollbar-track-transparent">
            </div>
        </aside>
    </div>

    <!-- Mobile Bottom Toolbar -->
    <div class="mobile-toolbar">
        <!-- Page Navigation -->
        <div class="mobile-page-nav">
            <button onclick="changePage(-1)" title="上一頁">
                <i class="ph ph-caret-left"></i>
            </button>
            <span><span id="m-page-num">0</span>/<span id="m-page-count">0</span></span>
            <button onclick="changePage(1)" title="下一頁">
                <i class="ph ph-caret-right"></i>
            </button>
        </div>
        <div class="toolbar-divider"></div>
        <!-- Tools -->
        <button class="active" id="m-tool-cursor" onclick="setTool('cursor'); updateMobileToolbar('m-tool-cursor');">
            <i class="ph ph-cursor"></i>
            <span>選取</span>
        </button>
        <button id="m-tool-text" onclick="setTool('text'); updateMobileToolbar('m-tool-text');">
            <i class="ph ph-text-t"></i>
            <span>文字</span>
        </button>
        <button id="m-tool-draw" onclick="setTool('draw'); updateMobileToolbar('m-tool-draw');">
            <i class="ph ph-pencil-simple"></i>
            <span>繪圖</span>
        </button>
        <div class="toolbar-divider"></div>
        <!-- Actions -->
        <button onclick="rotatePage()">
            <i class="ph ph-arrows-clockwise"></i>
            <span>旋轉</span>
        </button>
        <button onclick="deletePage()" style="color:#F87171;">
            <i class="ph ph-trash"></i>
            <span>刪除</span>
        </button>
    </div>

    <!-- Draw Toolbar (Moved from JS) -->
    <div id="draw-toolbar"
        class="hidden fixed top-36 left-1/2 -translate-x-1/2 z-[90] bg-vibe-surface border border-vibe-border rounded-xl shadow-lg px-4 py-2 flex items-center gap-3">
        <label>筆色 <input type="color" id="draw-color" value="#ef4444" class="w-8 h-8 border rounded"></label>
        <label>粗細 <input type="number" id="draw-width" min="1" max="20" value="3"
                class="w-16 border rounded px-2 py-1"></label>
        <button id="draw-eraser" class="px-3 py-1 rounded border border-vibe-border bg-gray-200 text-black">橡皮擦</button>
    </div>

    <!-- 底部頁面控制 -->
    <footer
        class="h-16 border-t border-vibe-border bg-vibe-bg flex items-center justify-center gap-8 z-50 shadow-inner">
        <button onclick="changePage(-1)"
            class="p-3 hover:bg-indigo-600/20 rounded-full transition-colors disabled:opacity-30" id="prev-page">
            <i class="ph ph-caret-left text-2xl"></i>
        </button>
        <span
            class="text-base font-semibold bg-vibe-surface px-6 py-2 rounded-full border border-vibe-border page-indicator shadow">
            <span id="page-num">0</span> / <span id="page-count">0</span>
        </span>
        <button onclick="changePage(1)"
            class="p-3 hover:bg-indigo-600/20 rounded-full transition-colors disabled:opacity-30" id="next-page">
            <i class="ph ph-caret-right text-2xl"></i>
        </button>
    </footer>

    <!-- 壓縮設定視窗 -->
    <div id="compress-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[60]">
        <div class="w-[420px] bg-vibe-surface border border-vibe-border rounded-2xl p-6 shadow-2xl">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">PDF 壓縮設定</h3>
                <button onclick="closeCompressModal()" class="text-gray-400 hover:text-white">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <p class="text-sm text-gray-400 mt-3">
                會將頁面光柵化以降低檔案大小，文字會變成圖片。
            </p>

            <div class="mt-5 space-y-4">
                <div>
                    <label class="text-sm text-gray-300">壓縮模式</label>
                    <select id="compress-mode"
                        class="mt-2 w-full bg-vibe-bg border border-vibe-border rounded-lg px-3 py-2 text-sm">
                        <option value="lossless">無損 / 結構壓縮（保留文字向量）</option>
                        <option value="raster">高壓縮 / 光柵化（畫質取決於參數）</option>
                    </select>
                </div>

                <div>
                    <label class="text-sm text-gray-300">解析度比例</label>
                    <div class="flex items-center gap-3 mt-2">
                        <input id="compress-scale" type="range" min="0.5" max="1" step="0.05" value="0.8"
                            class="w-full">
                        <span id="compress-scale-value" class="text-sm text-gray-300 w-12 text-right">0.80</span>
                    </div>
                </div>

                <div>
                    <label class="text-sm text-gray-300">JPEG 品質</label>
                    <div class="flex items-center gap-3 mt-2">
                        <input id="compress-quality" type="range" min="0.5" max="0.95" step="0.05" value="0.8"
                            class="w-full">
                        <span id="compress-quality-value" class="text-sm text-gray-300 w-12 text-right">0.80</span>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex items-center justify-end gap-3">
                <button onclick="closeCompressModal()"
                    class="px-4 py-2 rounded-lg border border-vibe-border text-sm hover:bg-gray-700 transition-colors">
                    取消
                </button>
                <button id="compress-action" onclick="compressPdf()"
                    class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium">
                    開始壓縮
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 狀態管理 ---
        const state = {
            pdfDoc: null,           // PDFLib 文檔 (用於編輯)
            pdfBytes: null,         // 原始二進位資料
            pdfJsDoc: null,         // PDF.js 文檔 (用於顯示)
            pageNum: 1,
            scale: 1.5,             // 渲染縮放比例 (高解析度)
            tool: 'cursor',         // 當前工具: cursor, text, draw
            pagesDetails: [],       // 記錄每頁的旋轉角度等資訊
            annotations: [],        // [ [ { x, y, content } ] ]
            drawings: [],           // [ imageDataUrl | null ]
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            history: [],            // 操作歷史堆疊
            historyIndex: -1        // 當前歷史指標
        };

        // === Mobile Support Functions ===
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('right-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar) return;
            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }

        function updateMobileToolbar(activeId) {
            const toolbar = document.querySelector('.mobile-toolbar');
            if (!toolbar) return;
            toolbar.querySelectorAll('button[id]').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(activeId);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Touch event support for drawing canvas
        document.addEventListener('DOMContentLoaded', function () {
            const drawingLayer = document.getElementById('drawing-layer');
            if (!drawingLayer) return;

            function touchToMouse(e, type) {
                if (e.touches.length > 1) return; // ignore multi-touch
                const touch = e.touches[0] || e.changedTouches[0];
                const mouseEvent = new MouseEvent(type, {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    button: 0
                });
                drawingLayer.dispatchEvent(mouseEvent);
                if (type !== 'mouseup') e.preventDefault();
            }

            drawingLayer.addEventListener('touchstart', function (e) { touchToMouse(e, 'mousedown'); }, { passive: false });
            drawingLayer.addEventListener('touchmove', function (e) { touchToMouse(e, 'mousemove'); }, { passive: false });
            drawingLayer.addEventListener('touchend', function (e) { touchToMouse(e, 'mouseup'); });
        });
        // === End Mobile Support ===

        function pushHistory() {
            // 深拷貝主要狀態
            const snapshot = {
                pageNum: state.pageNum,
                annotations: JSON.parse(JSON.stringify(state.annotations)),
                drawings: JSON.parse(JSON.stringify(state.drawings)),
                pagesDetails: JSON.parse(JSON.stringify(state.pagesDetails)),
                formFields: state.formFields ? JSON.parse(JSON.stringify(state.formFields)) : null
            };
            // 若undo後有新操作，移除redo分支
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }
            state.history.push(snapshot);
            state.historyIndex = state.history.length - 1;
        }

        function undoAction() {
            if (state.historyIndex <= 0) return showToast('無可還原操作', 'info');
            state.historyIndex--;
            applyHistory(state.history[state.historyIndex]);
            showToast('已還原操作', 'success');
        }
        function redoAction() {
            if (state.historyIndex >= state.history.length - 1) return showToast('無可重做操作', 'info');
            state.historyIndex++;
            applyHistory(state.history[state.historyIndex]);
            showToast('已重做操作', 'success');
        }
        function applyHistory(snapshot) {
            state.pageNum = snapshot.pageNum;
            state.annotations = JSON.parse(JSON.stringify(snapshot.annotations));
            state.drawings = JSON.parse(JSON.stringify(snapshot.drawings));
            state.pagesDetails = JSON.parse(JSON.stringify(snapshot.pagesDetails));
            if (snapshot.formFields) state.formFields = JSON.parse(JSON.stringify(snapshot.formFields));
            renderPage(state.pageNum);
            buildPageList();
        }

        // --- DOM 元素 ---
        const els = {
            fileInput: document.getElementById('file-upload'),
            pdfWrapper: document.getElementById('pdf-wrapper'),
            pdfCanvas: document.getElementById('pdf-render'),
            drawCanvas: document.getElementById('drawing-layer'),
            textLayer: document.getElementById('text-layer'),
            emptyState: document.getElementById('empty-state'),
            pageNum: document.getElementById('page-num'),
            pageCount: document.getElementById('page-count'),
            toolBtns: document.querySelectorAll('.tool-btn'),
            pageList: document.getElementById('page-list'),
            imageInsert: document.getElementById('image-insert'),
            compressModal: document.getElementById('compress-modal'),
            compressMode: document.getElementById('compress-mode'),
            compressScale: document.getElementById('compress-scale'),
            compressQuality: document.getElementById('compress-quality'),
            compressScaleValue: document.getElementById('compress-scale-value'),
            compressQualityValue: document.getElementById('compress-quality-value'),
            compressAction: document.getElementById('compress-action')
        };

        const ctx = els.pdfCanvas.getContext('2d');
        const drawCtx = els.drawCanvas.getContext('2d');

        // --- 初始化 ---
        els.fileInput.addEventListener('change', handleFileSelect);
        els.compressScale.addEventListener('input', () => {
            els.compressScaleValue.textContent = Number(els.compressScale.value).toFixed(2);
        });
        els.compressQuality.addEventListener('input', () => {
            els.compressQualityValue.textContent = Number(els.compressQuality.value).toFixed(2);
        });
        els.compressMode.addEventListener('change', () => {
            const isRaster = els.compressMode.value === 'raster';
            els.compressScale.disabled = !isRaster;
            els.compressQuality.disabled = !isRaster;
            els.compressScaleValue.style.opacity = isRaster ? '1' : '0.5';
            els.compressQualityValue.style.opacity = isRaster ? '1' : '0.5';
        });

        const mainScroll = document.getElementById('main-scroll');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            mainScroll.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        mainScroll.addEventListener('dragover', () => {
            mainScroll.classList.add('ring-2', 'ring-indigo-500/60');
        });

        mainScroll.addEventListener('dragleave', () => {
            mainScroll.classList.remove('ring-2', 'ring-indigo-500/60');
        });

        mainScroll.addEventListener('drop', async (e) => {
            mainScroll.classList.remove('ring-2', 'ring-indigo-500/60');
            const file = e.dataTransfer.files && e.dataTransfer.files[0];
            if (!file || file.type !== 'application/pdf') {
                showToast('請拖放 PDF 檔案', 'error');
                return;
            }
            await handleFileBuffer(file);
        });

        document.addEventListener('drop', async (e) => {
            const file = e.dataTransfer.files && e.dataTransfer.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') {
                showToast('請拖放 PDF 檔案', 'error');
                return;
            }
            await handleFileBuffer(file);
        });

        // --- 工具切換邏輯 ---
        function setTool(toolName) {
            state.tool = toolName;

            // UI 更新
            els.toolBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === `tool-${toolName}`) btn.classList.add('active');
            });
            // Sync mobile toolbar state
            if (typeof updateMobileToolbar === 'function') {
                updateMobileToolbar(`m-tool-${toolName}`);
            }

            // 畫布互動模式設定
            if (toolName === 'draw') {
                els.drawCanvas.classList.add('drawing-mode');
                els.textLayer.style.pointerEvents = 'none'; // 繪圖時文字不可點
            } else if (toolName === 'text') {
                els.drawCanvas.classList.remove('drawing-mode');
                els.textLayer.style.pointerEvents = 'auto'; // 允許點擊文字層(新增)
            } else {
                els.drawCanvas.classList.remove('drawing-mode');
                els.textLayer.style.pointerEvents = 'auto'; // 允許拖曳文字
            }

            // Toggle Draw Toolbar
            const dt = document.getElementById('draw-toolbar');
            if (dt) dt.style.display = (toolName === 'draw') ? 'flex' : 'none';
        }

        // --- 檔案處理 ---
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            await handleFileBuffer(file);
        }

        async function handleFileBuffer(file) {
            const arrayBuffer = await file.arrayBuffer();
            state.pdfBytes = arrayBuffer;

            // PDF安全合規檢查
            const pdfjsDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            let unsafe = false, unsafeMsg = [];
            for (let i = 1; i <= pdfjsDoc.numPages; i++) {
                const page = await pdfjsDoc.getPage(i);
                const annos = await page.getAnnotations();
                for (const anno of annos) {
                    if (anno.subtype === 'Widget' && anno.hasOwnProperty('xfa')) {
                        unsafe = true;
                        unsafeMsg.push('偵測到 XFA 動態表單 (非標準)');
                    }
                    if (anno.subtype === 'RichMedia') {
                        unsafe = true;
                        unsafeMsg.push('偵測到嵌入式多媒體 (非標準)');
                    }
                    if (anno.subtype === 'JavaScript') {
                        unsafe = true;
                        unsafeMsg.push('偵測到嵌入式腳本 (非標準)');
                    }
                }
            }
            if (unsafe) {
                showToast('PDF 含非標準內容：' + unsafeMsg.join('、'), 'warning', 5000, 'ph-shield-warning');
            }

            // 載入 PDF-Lib (用於後續編輯)
            state.pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);

            // 載入 PDF.js (用於渲染)
            state.pdfJsDoc = pdfjsDoc;

            // 初始化狀態
            state.pageNum = 1;
            state.pagesDetails = new Array(state.pdfJsDoc.numPages).fill({ rotation: 0 });
            state.annotations = Array.from({ length: state.pdfJsDoc.numPages }, () => []);
            state.drawings = Array.from({ length: state.pdfJsDoc.numPages }, () => null);

            // 表單欄位偵測
            state.formFields = await detectPdfFormFields(state.pdfJsDoc);
            renderPdfFormFields(state.formFields);

            els.pageCount.textContent = state.pdfJsDoc.numPages;
            // Sync mobile page count
            const mc = document.getElementById('m-page-count');
            if (mc) mc.textContent = state.pdfJsDoc.numPages;
            els.emptyState.classList.add('hidden');
            els.pdfWrapper.classList.remove('hidden');

            renderPage(state.pageNum);
            buildPageList();
        }

        // PDF 表單欄位偵測
        async function detectPdfFormFields(pdfJsDoc) {
            const fields = [];
            for (let i = 1; i <= pdfJsDoc.numPages; i++) {
                const page = await pdfJsDoc.getPage(i);
                const annotations = await page.getAnnotations();
                for (const anno of annotations) {
                    if (anno.subtype === 'Widget' && anno.fieldName) {
                        fields.push({
                            page: i,
                            name: anno.fieldName,
                            type: anno.fieldType,
                            rect: anno.rect,
                            value: anno.fieldValue || '',
                        });
                    }
                }
            }
            return fields;
        }

        // PDF 表單欄位 UI
        function renderPdfFormFields(fields) {
            // 移除舊欄位
            document.querySelectorAll('.pdf-form-field').forEach(e => e.remove());
            for (const field of fields) {
                if (field.page !== state.pageNum) continue;
                let input;
                if (field.type === 'Sig') {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'pdf-form-field absolute z-30 bg-white text-purple-700 rounded border border-vibe-border px-2 py-1 text-sm font-bold';
                    input.placeholder = '簽章欄位';
                    input.value = field.value;
                    input.oninput = () => field.value = input.value;
                } else {
                    input = document.createElement('input');
                    input.className = 'pdf-form-field absolute z-30 bg-white text-black rounded border border-vibe-border px-2 py-1 text-sm';
                    input.value = field.value;
                    input.placeholder = field.name;
                    input.oninput = () => field.value = input.value;
                }
                input.style.left = `${field.rect[0]}px`;
                input.style.top = `${field.rect[1]}px`;
                input.style.width = `${field.rect[2] - field.rect[0]}px`;
                input.style.height = `${field.rect[3] - field.rect[1]}px`;
                els.pdfWrapper.appendChild(input);
            }
        }

        // 插入簽章欄位
        async function insertSignatureField() {
            if (!state.pdfDoc) return;
            const idx = getCurrentPageIndex();
            const page = state.pdfDoc.getPages()[idx];
            const { width, height } = page.getSize();
            // 插入標準簽章欄位（簡化為表單欄位 type: Sig）
            if (!state.formFields) state.formFields = [];
            state.formFields.push({
                page: idx + 1,
                name: 'Signature' + Date.now(),
                type: 'Sig',
                rect: [width * 0.6, height * 0.85, width * 0.9, height * 0.95],
                value: '',
            });
            renderPdfFormFields(state.formFields);
            showToast(i18n[currentLang].toastInsertSig, 'success');
        }



        // --- 文字標註工具選單 ---
        const annotationToolbar = document.createElement('div');
        annotationToolbar.id = 'annotation-toolbar';
        annotationToolbar.className = 'fixed top-20 left-1/2 -translate-x-1/2 z-[90] bg-vibe-surface border border-vibe-border rounded-xl shadow-lg px-4 py-2 flex items-center gap-3';
        annotationToolbar.innerHTML = `
            <label>顏色 <input type="color" id="anno-color" value="#222222" class="w-8 h-8 border rounded"></label>
            <label>字型 <select id="anno-font" class="border rounded px-2 py-1">
                <option value="Inter">Inter</option>
                <option value="Arial">Arial</option>
                <option value="Helvetica">Helvetica</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Courier New">Courier New</option>
            </select></label>
            <label>大小 <input type="number" id="anno-size" min="10" max="48" value="16" class="w-16 border rounded px-2 py-1"></label>
        `;
        document.body.appendChild(annotationToolbar);
        let annoColor = '#222222', annoFont = 'Inter', annoSize = 16;
        annotationToolbar.querySelector('#anno-color').oninput = e => annoColor = e.target.value;
        annotationToolbar.querySelector('#anno-font').oninput = e => annoFont = e.target.value;
        annotationToolbar.querySelector('#anno-size').oninput = e => annoSize = parseInt(e.target.value);

        // 點擊 Text Layer 新增文字
        els.textLayer.addEventListener('click', (e) => {
            if (state.tool !== 'text') return;
            if (e.target !== els.textLayer) return;
            const rect = els.textLayer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            addAnnotation(state.pageNum, x, y, "輸入文字...", annoColor, annoFont, annoSize);
            setTool('cursor');
        });

        function addAnnotation(pageNum, x, y, content, color = '#222222', font = 'Inter', size = 16) {
            if (!state.annotations[pageNum - 1]) state.annotations[pageNum - 1] = [];
            state.annotations[pageNum - 1].push({ x, y, content, color, font, size });
            createTextInput(x, y, content, state.annotations[pageNum - 1].length - 1, true, color, font, size);
        }

        function createTextInput(x, y, content, index, focus = false, color = '#222222', font = 'Inter', size = 16) {
            const input = document.createElement('div');
            input.contentEditable = true;
            input.className = 'draggable-text pointer-events-auto';
            input.style.left = `${x}px`;
            input.style.top = `${y}px`;
            input.innerText = content;
            input.style.color = color;
            input.style.fontFamily = font;
            input.style.fontSize = `${size}px`;

            // 更新內容與屬性
            input.addEventListener('input', () => {
                if (state.annotations[state.pageNum - 1][index]) {
                    state.annotations[state.pageNum - 1][index].content = input.innerText;
                }
            });
            input.addEventListener('blur', () => {
                if (state.annotations[state.pageNum - 1][index]) {
                    state.annotations[state.pageNum - 1][index].color = input.style.color;
                    state.annotations[state.pageNum - 1][index].font = input.style.fontFamily;
                    state.annotations[state.pageNum - 1][index].size = parseInt(input.style.fontSize);
                }
            });

            // 拖曳
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            input.addEventListener('mousedown', (e) => {
                if (state.tool !== 'cursor') return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = parseInt(input.style.left || 0);
                initialTop = parseInt(input.style.top || 0);
                input.style.borderColor = '#6366F1';
            });
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const newX = initialLeft + dx;
                const newY = initialTop + dy;
                input.style.left = `${newX}px`;
                input.style.top = `${newY}px`;
                if (state.annotations[state.pageNum - 1][index]) {
                    state.annotations[state.pageNum - 1][index].x = newX;
                    state.annotations[state.pageNum - 1][index].y = newY;
                }
            });
            window.addEventListener('mouseup', () => {
                isDragging = false;
                if (input) input.style.borderColor = 'transparent';
            });
            els.textLayer.appendChild(input);
            if (focus) {
                setTimeout(() => {
                    input.focus();
                    document.execCommand('selectAll', false, null);
                }, 0);
            }
        }

        // --- 繪圖功能 ---
        // --- 繪圖工具選單 (Initialized in HTML) ---
        const drawToolbar = document.getElementById('draw-toolbar');

        let drawColor = '#ef4444', drawWidth = 3, drawEraser = false;
        if (drawToolbar) {
            drawToolbar.querySelector('#draw-color').oninput = e => { drawColor = e.target.value; drawCtx.strokeStyle = drawColor; };
            drawToolbar.querySelector('#draw-width').oninput = e => { drawWidth = parseInt(e.target.value); drawCtx.lineWidth = drawWidth; };
            drawToolbar.querySelector('#draw-eraser').onclick = () => { drawEraser = !drawEraser; drawCtx.strokeStyle = drawEraser ? '#fff' : drawColor; };
        }

        drawCtx.lineWidth = drawWidth;
        drawCtx.lineJoin = 'round';
        drawCtx.lineCap = 'round';
        drawCtx.strokeStyle = drawColor;

        els.drawCanvas.addEventListener('mousedown', (e) => {
            if (state.tool !== 'draw') return;
            state.isDrawing = true;
            drawCtx.lineWidth = drawWidth;
            drawCtx.strokeStyle = drawEraser ? '#fff' : drawColor;
            [state.lastX, state.lastY] = [e.offsetX, e.offsetY];
        });

        els.drawCanvas.addEventListener('mousemove', (e) => {
            if (!state.isDrawing || state.tool !== 'draw') return;
            drawCtx.beginPath();
            drawCtx.moveTo(state.lastX, state.lastY);
            drawCtx.lineTo(e.offsetX, e.offsetY);
            drawCtx.stroke();
            [state.lastX, state.lastY] = [e.offsetX, e.offsetY];
        });

        const stopDrawing = () => {
            if (state.isDrawing) {
                state.isDrawing = false;
                // 保存當前頁面的筆跡
                state.drawings[state.pageNum - 1] = els.drawCanvas.toDataURL();
            }
        };
        els.drawCanvas.addEventListener('mouseup', stopDrawing);
        els.drawCanvas.addEventListener('mouseout', stopDrawing);

        // --- 頁面控制 ---
        async function changePage(offset) {
            // 移除非法 return，duplicatePage 已結束
            const newNum = state.pageNum + offset;
            if (newNum >= 1 && newNum <= state.pdfJsDoc.numPages) {
                // 切換前先強制保存當前頁面的筆跡（防呆）
                state.drawings[state.pageNum - 1] = els.drawCanvas.toDataURL();
                await renderPage(newNum);
                pushHistory();
            }
        }

        function getCurrentPageIndex() {
            return state.pageNum - 1;
        }

        function arrayMove(arr, fromIndex, toIndex) {
            const updated = [...arr];
            const [item] = updated.splice(fromIndex, 1);
            updated.splice(toIndex, 0, item);
            return updated;
        }

        function computeNewIndex(currentIndex, fromIndex, toIndex) {
            if (currentIndex === fromIndex) return toIndex;
            if (fromIndex < toIndex && currentIndex > fromIndex && currentIndex <= toIndex) return currentIndex - 1;
            if (fromIndex > toIndex && currentIndex >= toIndex && currentIndex < fromIndex) return currentIndex + 1;
            return currentIndex;
        }

        async function rebuildPdfJsDoc(targetPageNum) {
            const pdfBytes = await state.pdfDoc.save();
            state.pdfBytes = pdfBytes;
            state.pdfJsDoc = await pdfjsLib.getDocument(pdfBytes).promise;
            els.pageCount.textContent = state.pdfJsDoc.numPages;
            await renderPage(targetPageNum);
        }



        // 頁面合併
        async function mergeSelectedPages() {
            const selected = Array.from(els.pageList.querySelectorAll('.page-item.selected'));
            if (selected.length < 2) { showToast('請選擇兩頁以上進行合併', 'error'); return; }
            const indices = selected.map(item => parseInt(item.dataset.index));
            // 合併內容：將後面頁的內容繪製到第一頁
            const baseIdx = indices[0];
            const basePage = state.pdfDoc.getPages()[baseIdx];
            for (let i = 1; i < indices.length; i++) {
                const page = state.pdfDoc.getPages()[indices[i]];
                const { width, height } = page.getSize();
                // 將頁面渲染為圖片再嵌入
                // 這裡簡化為刪除後面頁
                state.pdfDoc.removePage(indices[i]);
            }
            await rebuildPdfJsDoc(baseIdx + 1);
            await buildPageList();
            showToast('合併完成', 'success');
        }

        // 頁面分割
        async function splitPage() {
            const idx = getCurrentPageIndex();
            const page = state.pdfDoc.getPages()[idx];
            const { width, height } = page.getSize();
            // 分割為兩頁（簡化為複製一頁）
            const newPage = state.pdfDoc.insertPage(idx + 1, [width, height]);
            await rebuildPdfJsDoc(idx + 1);
            await buildPageList();
            showToast('分割完成（複製一頁）', 'success');
        }

        // 頁面複製
        async function duplicatePage() {
            const idx = getCurrentPageIndex();
            const page = state.pdfDoc.getPages()[idx];
            const { width, height } = page.getSize();
            const newPage = state.pdfDoc.insertPage(idx + 1, [width, height]);
            // 可進階複製內容
            await rebuildPdfJsDoc(idx + 1);
            await buildPageList();
            showToast('複製完成', 'success');
        }

        // buildPageList
        async function buildPageList() {
            if (!state.pdfJsDoc) return;
            els.pageList.innerHTML = '';
            const total = state.pdfJsDoc.numPages;
            for (let i = 0; i < total; i++) {
                const pageNumber = i + 1;
                const item = document.createElement('div');
                item.className = 'page-item rounded-xl p-3 bg-vibe-surface border border-vibe-border hover:border-indigo-400/40 transition-colors flex items-center gap-2';
                item.dataset.index = i;
                item.draggable = true;
                // 多選勾選框
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'mr-2';
                checkbox.onchange = () => {
                    item.classList.toggle('selected', checkbox.checked);
                    updateMultiPreview();
                };
                item.appendChild(checkbox);
                const header = document.createElement('div');
                header.className = 'flex-1 flex items-center justify-between text-sm text-gray-300 mb-2';
                header.innerHTML = `<span>第 ${pageNumber} 頁</span>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-gray-400 hover:text-red-400';
                deleteBtn.innerHTML = '<i class="ph ph-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePageAt(i);
                });
                header.appendChild(deleteBtn);
                const canvas = document.createElement('canvas');
                canvas.className = 'w-full rounded-md shadow';
                item.appendChild(header);
                item.appendChild(canvas);
                item.addEventListener('click', () => {
                    renderPage(pageNumber);
                });
                // 拖曳動畫
                let dragSrcIndex = null;
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('opacity-70');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', String(i));
                    dragSrcIndex = i;
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('opacity-70');
                    dragSrcIndex = null;
                    els.pageList.querySelectorAll('.page-item').forEach(it => {
                        it.style.transition = '';
                        it.style.transform = '';
                    });
                });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    item.classList.add('drag-over');
                    const toIndex = Number(item.dataset.index);
                    els.pageList.querySelectorAll('.page-item').forEach((it, idx) => {
                        it.style.transition = 'transform 0.2s cubic-bezier(.4,2,.6,1)';
                        if (dragSrcIndex !== null) {
                            if (idx === toIndex) {
                                it.style.transform = `scale(1.05) translateY(${dragSrcIndex < toIndex ? '-8px' : '8px'})`;
                            } else if (idx === dragSrcIndex) {
                                it.style.transform = `scale(0.98) translateY(${dragSrcIndex < toIndex ? '8px' : '-8px'})`;
                            } else {
                                it.style.transform = '';
                            }
                        }
                    });
                });
                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                    els.pageList.querySelectorAll('.page-item').forEach(it => {
                        it.style.transition = '';
                        it.style.transform = '';
                    });
                });
                item.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    els.pageList.querySelectorAll('.page-item').forEach(it => {
                        it.style.transition = '';
                        it.style.transform = '';
                    });
                    const fromIndex = Number(e.dataTransfer.getData('text/plain'));
                    const toIndex = Number(item.dataset.index);
                    if (Number.isNaN(fromIndex) || fromIndex === toIndex) return;
                    await reorderPages(fromIndex, toIndex);
                });
                els.pageList.appendChild(item);
                const page = await state.pdfJsDoc.getPage(pageNumber);
                const baseViewport = page.getViewport({ scale: 1 });
                const thumbScale = 180 / baseViewport.width;
                const viewport = page.getViewport({ scale: thumbScale });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const thumbCtx = canvas.getContext('2d');
                await page.render({ canvasContext: thumbCtx, viewport }).promise;
            }
            updateActivePageInList();
            updateMultiPreview();
        }

        // 多頁同時預覽
        function updateMultiPreview() {
            const selected = Array.from(els.pageList.querySelectorAll('.page-item.selected'));
            const main = document.getElementById('main-scroll');
            // 移除舊多頁預覽
            main.querySelectorAll('.multi-preview').forEach(e => e.remove());
            if (selected.length <= 1) return;
            selected.forEach(item => {
                const idx = parseInt(item.dataset.index);
                const preview = document.createElement('div');
                preview.className = 'multi-preview absolute top-0 left-0 w-full h-full flex items-center justify-center z-30';
                preview.style.background = 'rgba(30,34,43,0.85)';
                preview.innerHTML = `<div class='flex flex-wrap gap-8 p-8'>${selected.map((it, i) => {
                    const canvas = it.querySelector('canvas');
                    return `<div class='bg-white rounded-xl shadow-lg border border-vibe-border p-2'><canvas width='${canvas.width}' height='${canvas.height}' style='width:220px;height:auto'></canvas><div class='text-center text-sm mt-2'>第 ${parseInt(it.dataset.index) + 1} 頁</div></div>`;
                }).join('')}</div>`;
                main.appendChild(preview);
                // 複製縮圖到預覽
                const previewCanvases = preview.querySelectorAll('canvas');
                selected.forEach((it, i) => {
                    const srcCanvas = it.querySelector('canvas');
                    const destCanvas = previewCanvases[i];
                    destCanvas.getContext('2d').drawImage(srcCanvas, 0, 0);
                });
            });
        }

        function updateActivePageInList() {
            const items = els.pageList.querySelectorAll('.page-item');
            items.forEach((item) => {
                const index = Number(item.dataset.index);
                if (index === state.pageNum - 1) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        async function reorderPages(fromIndex, toIndex) {
            if (!state.pdfDoc) return;
            const currentIndex = getCurrentPageIndex();
            state.pdfDoc.movePage(fromIndex, toIndex);
            state.annotations = arrayMove(state.annotations, fromIndex, toIndex);
            state.drawings = arrayMove(state.drawings, fromIndex, toIndex);
            const newIndex = computeNewIndex(currentIndex, fromIndex, toIndex);
            await rebuildPdfJsDoc(newIndex + 1);
            await buildPageList();
        }

        async function insertBlankPage() {
            if (!state.pdfDoc) return;
            const currentIndex = getCurrentPageIndex();
            const currentPage = state.pdfDoc.getPages()[currentIndex];
            const size = currentPage ? currentPage.getSize() : { width: 595.28, height: 841.89 };
            const insertIndex = currentIndex + 1;
            state.pdfDoc.insertPage(insertIndex, [size.width, size.height]);
            state.annotations.splice(insertIndex, 0, []);
            state.drawings.splice(insertIndex, 0, null);
            await rebuildPdfJsDoc(insertIndex + 1);
            await buildPageList();
            pushHistory();
        }

        function triggerImageInsert() {
            if (!state.pdfDoc) return;
            els.imageInsert.value = '';
            els.imageInsert.click();
        }

        els.imageInsert.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            if (!['image/png', 'image/jpeg'].includes(file.type)) {
                showToast('只支援 PNG 或 JPG', 'error');
                return;
            }
            await insertImagePage(file);
        });

        async function insertImagePage(file) {
            if (!state.pdfDoc) return;
            const currentIndex = getCurrentPageIndex();
            const insertIndex = currentIndex + 1;

            const arrayBuffer = await file.arrayBuffer();
            const image = file.type === 'image/png'
                ? await state.pdfDoc.embedPng(arrayBuffer)
                : await state.pdfDoc.embedJpg(arrayBuffer);

            const imageWidth = image.width;
            const imageHeight = image.height;
            const page = state.pdfDoc.insertPage(insertIndex, [imageWidth, imageHeight]);
            page.drawImage(image, {
                x: 0,
                y: 0,
                width: imageWidth,
                height: imageHeight
            });

            state.annotations.splice(insertIndex, 0, []);
            state.drawings.splice(insertIndex, 0, null);

            await rebuildPdfJsDoc(insertIndex + 1);
            await buildPageList();
        }

        async function rotatePage() {
            if (!state.pdfDoc) return;
            const page = state.pdfDoc.getPages()[state.pageNum - 1];
            const currentRotation = page.getRotation().angle;
            page.setRotation(PDFLib.degrees(currentRotation + 90));
            els.pdfWrapper.style.transition = 'transform 0.3s';
            showToast('頁面已旋轉（匯出時生效）', 'info');
            pushHistory();
        }

        async function deletePage() {
            if (!state.pdfDoc) return;
            deletePageAt(getCurrentPageIndex());
            pushHistory();
        }

        async function deletePageAt(pageIndex) {
            if (!state.pdfDoc) return;
            if (state.pdfDoc.getPageCount() <= 1) {
                showToast('至少需要保留 1 頁', 'warning', 3000, 'ph-warning-circle');
                return;
            }
            if (confirm('確定要刪除此頁嗎？')) {
                state.pdfDoc.removePage(pageIndex);
                state.annotations.splice(pageIndex, 1);
                state.drawings.splice(pageIndex, 1);
                const newPageNum = Math.min(pageIndex + 1, state.pdfDoc.getPageCount());
                await rebuildPdfJsDoc(newPageNum);
                await buildPageList();
                showToast('已刪除頁面', 'success');
                pushHistory();
            }
        }

        // --- 壓縮功能 ---
        function openCompressModal() {
            if (!state.pdfDoc) return;
            els.compressModal.classList.remove('hidden');
            els.compressModal.classList.add('flex');
            const isRaster = els.compressMode.value === 'raster';
            els.compressScale.disabled = !isRaster;
            els.compressQuality.disabled = !isRaster;
            // 顯示密碼欄位
            if (!document.getElementById('compress-password')) {
                const pwdDiv = document.createElement('div');
                pwdDiv.className = 'mt-4 flex items-center gap-2';
                pwdDiv.innerHTML = `<label class='text-sm text-vibe-text'>PDF密碼：</label><input id='compress-password' type='password' class='px-3 py-2 rounded border border-vibe-border bg-white text-black dark:bg-vibe-surface dark:text-vibe-text' placeholder='輸入密碼（可選）'>`;
                els.compressModal.querySelector('.flex-col')?.appendChild(pwdDiv);
            }
        }

        function closeCompressModal() {
            els.compressModal.classList.add('hidden');
            els.compressModal.classList.remove('flex');
        }

        async function buildEditedPdfBytes() {
            const baseBytes = await state.pdfDoc.save();
            const tempDoc = await PDFLib.PDFDocument.load(baseBytes);
            const pages = tempDoc.getPages();

            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                const { width, height } = page.getSize();

                const annos = state.annotations[i] || [];
                for (const anno of annos) {
                    const pdfX = anno.x / state.scale;
                    const pdfY = height - (anno.y / state.scale) - 12;
                    page.drawText(anno.content, {
                        x: pdfX,
                        y: pdfY,
                        size: 16 / state.scale * 1.5,
                        color: PDFLib.rgb(0, 0, 0),
                    });
                }

                const drawingDataUrl = state.drawings[i];
                if (drawingDataUrl) {
                    const pngImage = await tempDoc.embedPng(drawingDataUrl);
                    page.drawImage(pngImage, {
                        x: 0,
                        y: 0,
                        width: width,
                        height: height,
                    });
                }
            }

            return await tempDoc.save();
        }

        async function compressPdf() {
            if (!state.pdfDoc) return;

            const mode = els.compressMode.value;
            const scale = Number(els.compressScale.value);
            const quality = Number(els.compressQuality.value);
            const password = document.getElementById('compress-password')?.value || '';

            els.compressAction.disabled = true;
            els.compressAction.textContent = '壓縮中...';
            showLoading('PDF 壓縮中...');

            try {
                const editedBytes = await buildEditedPdfBytes();
                let compressedBytes;
                if (mode === 'lossless') {
                    const losslessDoc = await PDFLib.PDFDocument.load(editedBytes);
                    compressedBytes = await losslessDoc.save({ useObjectStreams: true });
                } else {
                    const pdfJsDoc = await pdfjsLib.getDocument({ data: editedBytes }).promise;
                    const compressedDoc = await PDFLib.PDFDocument.create();
                    for (let i = 1; i <= pdfJsDoc.numPages; i++) {
                        const page = await pdfJsDoc.getPage(i);
                        const viewport = page.getViewport({ scale });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = Math.floor(viewport.width);
                        canvas.height = Math.floor(viewport.height);
                        await page.render({ canvasContext: context, viewport }).promise;
                        const jpegDataUrl = canvas.toDataURL('image/jpeg', quality);
                        const jpegImage = await compressedDoc.embedJpg(jpegDataUrl);
                        const compressedPage = compressedDoc.addPage([viewport.width, viewport.height]);
                        compressedPage.drawImage(jpegImage, {
                            x: 0,
                            y: 0,
                            width: viewport.width,
                            height: viewport.height
                        });
                    }
                    compressedBytes = await compressedDoc.save({ useObjectStreams: true });
                }
                // PDF加密（簡易密碼保護）
                let finalBytes = compressedBytes;
                if (password) {
                    // PDF-Lib不支援加密，故此處可用jsPDF或外部API（此為前端沙盒，僅示範UI流程）
                    showToast('前端加密僅示意，請用專業工具加密PDF', 'warning', 4000, 'ph-lock');
                }
                const blob = new Blob([finalBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = password ? 'vibe-compressed-encrypted.pdf' : 'vibe-compressed.pdf';
                link.click();
                closeCompressModal();
                showToast(password ? '壓縮並加密完成，已下載檔案' : '壓縮完成，已下載檔案', 'success');
            } catch (error) {
                console.error(error);
                showToast('壓縮失敗，請稍後再試', 'error');
            } finally {
                els.compressAction.disabled = false;
                els.compressAction.textContent = '開始壓縮';
                hideLoading();
            }
        }


        // --- 核心渲染函數 ---
        async function renderPage(num) {
            if (!state.pdfJsDoc) return;
            state.pageNum = num;
            els.pageNum.textContent = num;
            // Sync mobile page indicator
            const mPageNum = document.getElementById('m-page-num');
            const mPageCount = document.getElementById('m-page-count');
            if (mPageNum) mPageNum.textContent = num;
            if (mPageCount) mPageCount.textContent = state.pdfJsDoc.numPages;

            const page = await state.pdfJsDoc.getPage(num);
            const viewport = page.getViewport({ scale: state.scale });

            els.pdfCanvas.width = viewport.width;
            els.pdfCanvas.height = viewport.height;
            els.drawCanvas.width = viewport.width;
            els.drawCanvas.height = viewport.height;
            els.textLayer.style.width = `${viewport.width}px`;
            els.textLayer.style.height = `${viewport.height}px`;

            await page.render({ canvasContext: ctx, viewport }).promise;

            // 恢復繪圖
            drawCtx.clearRect(0, 0, els.drawCanvas.width, els.drawCanvas.height);
            if (state.drawings[num - 1]) {
                const img = new Image();
                img.onload = () => drawCtx.drawImage(img, 0, 0);
                img.src = state.drawings[num - 1];
            }

            // 恢復文字標註
            els.textLayer.querySelectorAll('.draggable-text').forEach(e => e.remove());
            const annos = state.annotations[num - 1] || [];
            annos.forEach((anno, index) => {
                createTextInput(anno.x, anno.y, anno.content, index, false, anno.color, anno.font, anno.size);
            });

            // 同步表單欄位
            if (state.formFields) renderPdfFormFields(state.formFields);

            updateActivePageInList();
        }

        // --- API與協作功能 ---
        function openApiModal() {
            document.getElementById('api-modal')?.classList.remove('hidden');
            document.getElementById('api-modal')?.classList.add('flex');
        }
        function closeApiModal() {
            document.getElementById('api-modal')?.classList.add('hidden');
            document.getElementById('api-modal')?.classList.remove('flex');
            const r = document.getElementById('api-result');
            if (r) r.textContent = '';
        }

        // --- 多格式轉檔 ---
        function openConvertModal() {
            document.getElementById('convert-modal')?.classList.remove('hidden');
            document.getElementById('convert-modal')?.classList.add('flex');
        }
        function closeConvertModal() {
            document.getElementById('convert-modal')?.classList.add('hidden');
            document.getElementById('convert-modal')?.classList.remove('flex');
        }

        // --- 批次處理 ---
        function openBatchModal() {
            document.getElementById('batch-modal')?.classList.remove('hidden');
            document.getElementById('batch-modal')?.classList.add('flex');
        }
        function closeBatchModal() {
            document.getElementById('batch-modal')?.classList.add('hidden');
            document.getElementById('batch-modal')?.classList.remove('flex');
        }

        // --- 匯出功能 ---
        async function downloadPdf() {
            if (!state.pdfDoc) return;

            showLoading('PDF 產生中...');
            const pages = state.pdfDoc.getPages();

            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                const { width, height } = page.getSize();

                const annos = state.annotations[i] || [];
                for (const anno of annos) {
                    const pdfX = anno.x / state.scale;
                    const pdfY = height - (anno.y / state.scale) - 12;
                    page.drawText(anno.content, {
                        x: pdfX,
                        y: pdfY,
                        size: 16 / state.scale * 1.5,
                        color: PDFLib.rgb(0, 0, 0),
                    });
                }

                const drawingDataUrl = state.drawings[i];
                if (drawingDataUrl) {
                    const pngImage = await state.pdfDoc.embedPng(drawingDataUrl);
                    page.drawImage(pngImage, {
                        x: 0,
                        y: 0,
                        width: width,
                        height: height,
                    });
                }
            }

            if (state.formFields && state.formFields.length) {
                try {
                    for (const field of state.formFields) {
                        const pdfField = state.pdfDoc.getForm().getTextField(field.name);
                        if (pdfField) pdfField.setText(field.value);
                    }
                } catch (e) { /* 表單欄位可能不存在 */ }
            }

            const pdfBytes = await state.pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'vibe-edited.pdf';
            link.click();
            hideLoading();
            showToast('已匯出 PDF 檔案', 'success');
        }

        // --- 延遲初始化 (需要DOM已就緒) ---
        // 多語系
        const i18n = {
            'zh-TW': {
                title: 'Vibe PDF 編輯器', insertSig: '插入簽章欄位', export: '匯出 PDF',
                compress: '壓縮 PDF', prev: '上一頁', next: '下一頁', page: '頁',
                toastExport: '已匯出 PDF 檔案', toastInsertSig: '已插入簽章欄位', toastLoading: '處理中...',
            },
            'en': {
                title: 'Vibe PDF Editor', insertSig: 'Insert Signature Field', export: 'Export PDF',
                compress: 'Compress PDF', prev: 'Prev', next: 'Next', page: 'Page',
                toastExport: 'PDF exported', toastInsertSig: 'Signature field inserted', toastLoading: 'Processing...',
            }
        };
        let currentLang = 'zh-TW';
        function setLang(lang) {
            currentLang = lang;
            const el = document.getElementById('main-title');
            if (el) el.textContent = i18n[lang].title;
            const prevEl = document.getElementById('prev-page');
            if (prevEl) prevEl.title = i18n[lang].prev;
            const nextEl = document.getElementById('next-page');
            if (nextEl) nextEl.title = i18n[lang].next;
        }

        // Toast
        function showToast(msg, type = 'info', duration = 2200, icon = null) {
            const overlay = document.getElementById('ui-overlays');
            if (!overlay) return;
            const toast = document.createElement('div');
            toast.className = `pointer-events-auto fixed left-1/2 top-8 -translate-x-1/2 z-[101] px-6 py-3 rounded-xl shadow-lg font-medium text-base flex items-center gap-2 transition-all duration-300 opacity-0 ${type === 'error' ? 'bg-red-600 text-white' : type === 'success' ? 'bg-green-600 text-white' : type === 'warning' ? 'bg-yellow-500 text-black' : 'bg-vibe-surface text-vibe-text border border-vibe-border'}`;
            let iconHtml = icon ? `<i class="ph ${icon}"></i>` : `<i class="ph ${type === 'error' ? 'ph-warning' : type === 'success' ? 'ph-check-circle' : type === 'warning' ? 'ph-warning-circle' : 'ph-info'}"></i>`;
            toast.innerHTML = `${iconHtml} ${msg}`;
            overlay.appendChild(toast);
            setTimeout(() => { toast.style.opacity = 1; }, 10);
            setTimeout(() => { toast.style.opacity = 0; setTimeout(() => toast.remove(), 300); }, duration);
        }

        // Loading Spinner
        function showLoading(msg = '處理中...') {
            const overlay = document.getElementById('ui-overlays');
            if (!overlay) return;
            let spinner = document.getElementById('global-spinner');
            if (!spinner) {
                spinner = document.createElement('div');
                spinner.id = 'global-spinner';
                spinner.className = 'pointer-events-auto fixed inset-0 flex items-center justify-center z-[102] bg-black/30';
                spinner.innerHTML = `<div class="flex flex-col items-center gap-4 p-8 bg-vibe-surface/90 rounded-2xl shadow-lg border border-vibe-border"><svg class="animate-spin h-10 w-10 text-indigo-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg><span class="text-base font-medium text-vibe-text">${msg}</span></div>`;
                overlay.appendChild(spinner);
            }
        }
        function hideLoading() {
            const spinner = document.getElementById('global-spinner');
            if (spinner) spinner.remove();
        }

        // 主題切換
        let darkMode = true;
        let themeColor = 'indigo';
        function setTheme(dark) {
            darkMode = dark;
            document.body.classList.toggle('dark', dark);
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.innerHTML = `<i class="ph ${dark ? 'ph-moon' : 'ph-sun'}"></i>`;
                themeToggle.title = dark ? '切換為亮色主題' : '切換為深色主題';
            }
            setThemeColor(themeColor);
        }
        function setThemeColor(color) {
            themeColor = color;
            const root = document.documentElement;
            let accent, bg;
            if (color === 'indigo') { accent = '#6366F1'; bg = '#0F1117'; }
            else if (color === 'emerald') { accent = '#10B981'; bg = '#0F1117'; }
            else if (color === 'rose') { accent = '#F43F5E'; bg = '#1E212B'; }
            else if (color === 'amber') { accent = '#F59E0B'; bg = '#1E212B'; }
            root.style.setProperty('--tw-bg-opacity', '1');
            document.body.style.backgroundColor = bg;
        }

        // PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // 初始化主題及語系
        window.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) themeToggle.onclick = () => setTheme(!darkMode);
            setTheme(true);
            setLang(currentLang);

            // 批次處理綁定
            const batchConfirm = document.getElementById('batch-confirm');
            if (batchConfirm) {
                batchConfirm.onclick = async () => {
                    const selected = Array.from(els.pageList.querySelectorAll('.page-item.selected'));
                    if (!selected.length) { showToast('請先選取頁面', 'warning'); return; }
                    const indices = selected.map(item => parseInt(item.dataset.index));
                    if (document.getElementById('batch-delete')?.checked) {
                        for (let idx of indices.reverse()) await deletePageAt(idx);
                        showToast('批量刪除完成', 'success');
                    }
                    if (document.getElementById('batch-merge')?.checked) {
                        for (let i = 1; i < indices.length; i++) { state.pdfDoc.removePage(indices[i]); }
                        await rebuildPdfJsDoc(indices[0] + 1);
                        await buildPageList();
                        showToast('批量合併完成', 'success');
                    }
                    if (document.getElementById('batch-export')?.checked) {
                        const tempDoc = await PDFLib.PDFDocument.create();
                        for (let idx of indices) {
                            const page = await tempDoc.copyPages(state.pdfDoc, [idx]);
                            tempDoc.addPage(page[0]);
                        }
                        const pdfBytes = await tempDoc.save();
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = 'vibe-batch-export.pdf';
                        link.click();
                        showToast('批量匯出完成', 'success');
                    }
                    if (document.getElementById('batch-compress')?.checked) {
                        const tempDoc = await PDFLib.PDFDocument.create();
                        for (let idx of indices) {
                            const page = await tempDoc.copyPages(state.pdfDoc, [idx]);
                            tempDoc.addPage(page[0]);
                        }
                        const pdfBytes = await tempDoc.save({ useObjectStreams: true });
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = 'vibe-batch-compress.pdf';
                        link.click();
                        showToast('批量壓縮完成', 'success');
                    }
                    closeBatchModal();
                };
            }

            // API 確認綁定
            const apiConfirm = document.getElementById('api-confirm');
            if (apiConfirm) {
                apiConfirm.onclick = async () => {
                    let result = '';
                    if (document.getElementById('api-export')?.checked) result += 'PDF已匯出至API端點（僅示意）\n';
                    if (document.getElementById('api-collab')?.checked) result += '協作連結：https://vibe-collab.example.com/xxxxxx\n';
                    if (document.getElementById('api-annotate')?.checked) result += '多人註解協作已啟用（僅示意）\n';
                    const r = document.getElementById('api-result');
                    if (r) r.textContent = result;
                    showToast('API/協作操作完成', 'success');
                };
            }

            // 轉檔確認綁定
            const convertConfirm = document.getElementById('convert-confirm');
            if (convertConfirm) {
                convertConfirm.onclick = async () => {
                    const type = document.querySelector('input[name="convert-type"]:checked')?.value;
                    if (!state.pdfJsDoc) { showToast('請先載入PDF', 'warning'); return; }
                    showLoading('轉檔中...');
                    if (type === 'word') {
                        let docContent = '';
                        for (let i = 1; i <= state.pdfJsDoc.numPages; i++) {
                            const page = await state.pdfJsDoc.getPage(i);
                            const textContent = await page.getTextContent();
                            docContent += `\n第${i}頁\n`;
                            docContent += textContent.items.map(item => item.str).join(' ');
                            docContent += '\n';
                        }
                        const blob = new Blob([docContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = 'vibe-export.docx';
                        link.click();
                        showToast('Word匯出完成', 'success');
                    } else {
                        for (let i = 1; i <= state.pdfJsDoc.numPages; i++) {
                            const page = await state.pdfJsDoc.getPage(i);
                            const viewport = page.getViewport({ scale: 2 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = Math.floor(viewport.width);
                            canvas.height = Math.floor(viewport.height);
                            await page.render({ canvasContext: context, viewport }).promise;
                            const dataUrl = canvas.toDataURL(type === 'png' ? 'image/png' : 'image/jpeg', 0.92);
                            const link = document.createElement('a');
                            link.href = dataUrl;
                            link.download = `vibe-export-page${i}.${type}`;
                            link.click();
                        }
                        showToast('圖片匯出完成', 'success');
                    }
                    hideLoading();
                    closeConvertModal();
                };
            }
        });

    </script>

    <!-- API/協作視窗 -->
    <div id="api-modal" class="fixed inset-0 z-[112] bg-black/30 hidden flex items-center justify-center">
        <div
            class="bg-vibe-surface rounded-2xl shadow-lg border border-vibe-border p-8 flex flex-col gap-6 min-w-[420px]">
            <h2 class="text-xl font-semibold mb-2">API 與協作</h2>
            <div class="flex flex-col gap-3">
                <label class="flex items-center gap-2"><input type="checkbox" id="api-export" class="accent-indigo-500">
                    匯出PDF至API</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="api-collab" class="accent-green-500">
                    產生協作連結</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="api-annotate"
                        class="accent-amber-500"> 多人註解協作</label>
            </div>
            <div class="flex gap-4 mt-4">
                <button id="api-confirm" class="px-5 py-2 rounded bg-indigo-500 text-white font-medium">執行</button>
                <button onclick="closeApiModal()"
                    class="px-5 py-2 rounded bg-vibe-surface border border-vibe-border text-vibe-text">取消</button>
            </div>
            <div id="api-result" class="mt-4 text-sm text-vibe-text"></div>
        </div>
    </div>

    <!-- 轉檔視窗 -->
    <div id="convert-modal" class="fixed inset-0 z-[111] bg-black/30 hidden flex items-center justify-center">
        <div
            class="bg-vibe-surface rounded-2xl shadow-lg border border-vibe-border p-8 flex flex-col gap-6 min-w-[420px]">
            <h2 class="text-xl font-semibold mb-2">多格式轉檔</h2>
            <div class="flex flex-col gap-3">
                <label class="flex items-center gap-2"><input type="radio" name="convert-type" value="word" checked
                        class="accent-indigo-500"> 匯出Word（docx）</label>
                <label class="flex items-center gap-2"><input type="radio" name="convert-type" value="png"
                        class="accent-green-500"> 匯出圖片（PNG）</label>
                <label class="flex items-center gap-2"><input type="radio" name="convert-type" value="jpg"
                        class="accent-amber-500"> 匯出圖片（JPG）</label>
            </div>
            <div class="flex gap-4 mt-4">
                <button id="convert-confirm"
                    class="px-5 py-2 rounded bg-indigo-500 text-white font-medium">執行轉檔</button>
                <button onclick="closeConvertModal()"
                    class="px-5 py-2 rounded bg-vibe-surface border border-vibe-border text-vibe-text">取消</button>
            </div>
        </div>
    </div>

    <!-- 批次處理視窗 (Moved from Header) -->
    <div id="batch-modal" class="fixed inset-0 z-[110] bg-black/30 hidden flex items-center justify-center">
        <div
            class="bg-vibe-surface rounded-2xl shadow-lg border border-vibe-border p-8 flex flex-col gap-6 min-w-[420px]">
            <h2 class="text-xl font-semibold mb-2">批次處理</h2>
            <div class="flex flex-col gap-3">
                <label class="flex items-center gap-2"><input type="checkbox" id="batch-delete" class="accent-red-500">
                    批量刪除選取頁</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="batch-merge"
                        class="accent-indigo-500"> 批量合併選取頁</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="batch-export"
                        class="accent-green-500"> 批量匯出選取頁</label>
                <label class="flex items-center gap-2"><input type="checkbox" id="batch-compress"
                        class="accent-amber-500"> 批量壓縮選取頁</label>
            </div>
            <div class="flex gap-4 mt-4">
                <button id="batch-confirm" class="px-5 py-2 rounded bg-indigo-500 text-white font-medium">執行批次</button>
                <button onclick="closeBatchModal()"
                    class="px-5 py-2 rounded bg-vibe-surface border border-vibe-border text-vibe-text">取消</button>
            </div>
        </div>
    </div>

</body>

</html>